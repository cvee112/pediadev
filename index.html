<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PediaDev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom: 2px solid #2563EB; color: #2563EB; }
        .stat-card { transition: all 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .milestone-check { accent-color: #2563EB; }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Custom date input styling for mobile consistency */
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            min-height: 46px; /* Touch friendly height */
        }
    </style>
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Header -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-blue-600 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h1 class="text-xl font-bold text-slate-900 truncate">PediaDev <span class="hidden sm:inline text-sm font-normal text-slate-500 ml-2">Growth & Development Check</span></h1>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- Input Section -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6 mb-8">
            <h2 class="text-lg font-semibold text-slate-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                Patient Details
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                
                <!-- DOB -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Date of Birth</label>
                    <input type="date" id="dob" class="appearance-none block w-full rounded-lg border-slate-300 border bg-slate-50 text-slate-900 py-2.5 px-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none shadow-sm" onchange="calculate()">
                </div>

                <!-- Sex -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Sex</label>
                    <div class="flex space-x-4 mt-2 h-[46px] items-center">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="sex" value="male" class="form-radio h-4 w-4 text-blue-600 focus:ring-blue-500" onchange="calculate()">
                            <span class="ml-2">Male</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="sex" value="female" class="form-radio h-4 w-4 text-pink-600 focus:ring-pink-500" onchange="calculate()">
                            <span class="ml-2">Female</span>
                        </label>
                    </div>
                </div>

                <!-- Weight -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Weight (kg)</label>
                    <input type="number" id="weight" step="0.1" placeholder="e.g., 12.5" class="appearance-none block w-full rounded-lg border-slate-300 border bg-slate-50 text-slate-900 py-2.5 px-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none shadow-sm" oninput="calculate()">
                </div>

                <!-- Height -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Length/Height (cm)</label>
                    <input type="number" id="height" step="0.1" placeholder="e.g., 85.0" class="appearance-none block w-full rounded-lg border-slate-300 border bg-slate-50 text-slate-900 py-2.5 px-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none shadow-sm" oninput="calculate()">
                </div>

                <!-- Date of Visit -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Date of Visit</label>
                    <input type="date" id="visitDate" class="appearance-none block w-full rounded-lg border-slate-300 border bg-slate-50 text-slate-900 py-2.5 px-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none shadow-sm" onchange="calculate()">
                </div>
            </div>

            <!-- Age Display -->
            <div id="ageDisplay" class="mt-4 p-3 bg-blue-50 rounded-lg text-blue-800 text-sm font-medium hidden">
                <!-- Content populated by JS with improved layout -->
            </div>
            <div id="errorDisplay" class="mt-4 p-3 bg-red-50 rounded-lg text-red-800 text-sm font-medium hidden"></div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-slate-200 mb-6 overflow-x-auto scrollbar-hide">
            <nav class="-mb-px flex space-x-8 min-w-max" aria-label="Tabs">
                <button onclick="switchTab('anthropometry')" id="tab-anthropometry" class="tab-btn tab-active py-4 px-1 inline-flex items-center text-sm font-medium">
                    Anthropometry
                </button>
                <button onclick="switchTab('immunizations')" id="tab-immunizations" class="tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 py-4 px-1 inline-flex items-center text-sm font-medium">
                    Immunizations
                </button>
                <button onclick="switchTab('milestones')" id="tab-milestones" class="tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 py-4 px-1 inline-flex items-center text-sm font-medium">
                    Developmental Milestones
                </button>
            </nav>
        </div>

        <!-- Content: Anthropometry -->
        <div id="content-anthropometry" class="tab-content block">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="resultsGrid">
                <!-- Improved Placeholder for Mobile -->
                <div class="col-span-full py-12 bg-white rounded-xl border border-dashed border-slate-300 flex items-center justify-center">
                    <p class="text-center text-slate-400 px-8 max-w-xs mx-auto">
                        Enter patient data to see WHO growth analysis.
                    </p>
                </div>
            </div>
            
            <div id="dynamicNotesContainer" class="space-y-3 mt-6">
                <!-- Dynamic notes will be injected here -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-800 hidden" id="anthroNotes">
                    <strong>Note:</strong> <span id="heightNote"></span>
                </div>
            </div>
        </div>

        <!-- Content: Immunizations -->
        <div id="content-immunizations" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-slate-200 bg-slate-50 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                    <h3 class="font-semibold text-slate-900">Immunization Schedule (PIDSP 2026)</h3>
                    <div class="flex flex-wrap gap-2 text-xs">
                        <span class="px-2 py-1 rounded bg-red-100 text-red-800 font-medium">Overdue</span>
                        <span class="px-2 py-1 rounded bg-blue-100 text-blue-800 font-medium">Due Now</span>
                        <span class="px-2 py-1 rounded bg-slate-100 text-slate-600 font-medium">Upcoming</span>
                    </div>
                </div>
                
                <!-- Responsive Grid Container -->
                <div id="immunizationContainer" class="divide-y divide-slate-200">
                    <!-- Header (Visible only on Desktop) -->
                    <div class="hidden md:grid md:grid-cols-12 gap-4 px-6 py-3 bg-white border-b border-slate-200 font-bold text-xs text-slate-500 uppercase tracking-wider">
                        <div class="md:col-span-4">Vaccine</div>
                        <div class="md:col-span-2">Dose</div>
                        <div class="md:col-span-3">Rec. Age</div>
                        <div class="md:col-span-3 text-right">Status</div>
                    </div>
                    
                    <!-- Rows populated by JS -->
                </div>
            </div>
        </div>

        <!-- Content: Milestones -->
        <div id="content-milestones" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-slate-900">Developmental Check</h3>
                        <p class="text-sm text-slate-500">Based on CDC/AAP 2022 Revision (Comprehensive List)</p>
                    </div>
                    <div class="text-right">
                        <span id="milestoneAgeGroup" class="inline-flex items-center px-3 py-1 rounded-full text-xs sm:text-sm font-medium bg-indigo-100 text-indigo-800">
                            --
                        </span>
                    </div>
                </div>

                <!-- Container for multiple age groups -->
                <div id="milestoneGrid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-slate-200 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-slate-500 text-sm">
            <p>PediaDev. A clinical reference aid, not a medical device.</p>
            <p class="mt-2 text-xs">Sources: WHO Child Growth Standards, PIDSP 2026 Immunization Schedule, CDC/AAP 2022 Milestones.</p>
        </div>
    </footer>

    <!-- LOGIC -->
    <script>
        // --- DATA: WHO LMS Tables (Simplified for minimal file size, interpolated) ---
        // Format: [AgeInMonths, L, M, S]
        const WHO_DATA = {
            wfa_boys: [[0,0.1815,3.3466,0.1298],[1,-0.165,4.4709,0.136],[2,-0.088,5.5753,0.126],[3,-0.076,6.4357,0.121],[4,-0.083,7.0396,0.117],[5,-0.085,7.5484,0.115],[6,-0.096,7.9351,0.113],[9,-0.123,8.8778,0.112],[12,-0.163,9.6387,0.111],[18,-0.177,10.9161,0.114],[24,-0.148,12.1557,0.119],[36,-0.121,14.3399,0.124],[48,-0.106,16.3263,0.131],[60,-0.093,18.3076,0.136],[72,-0.155,20.52,0.147],[84,-0.207,22.9,0.158],[96,-0.252,25.64,0.169],[108,-0.291,28.69,0.179],[120,-0.325,32.06,0.189]],
            wfa_girls: [[0,0.1548,3.2322,0.1417],[1,-0.175,4.1873,0.133],[2,-0.102,5.1282,0.125],[3,-0.089,5.8427,0.119],[4,-0.096,6.4223,0.116],[5,-0.111,6.8926,0.114],[6,-0.126,7.297,0.113],[9,-0.16,8.2327,0.112],[12,-0.184,8.9481,0.113],[18,-0.198,10.2223,0.118],[24,-0.197,11.4848,0.123],[36,-0.184,13.851,0.131],[48,-0.175,16.0738,0.141],[60,-0.166,18.2119,0.15],[72,-0.133,20.24,0.161],[84,-0.168,22.45,0.174],[96,-0.208,25.04,0.188],[108,-0.252,28.23,0.201],[120,-0.298,31.91,0.214]],
            
            // Length (0-24m)
            lhfa_boys_0_2: [[0,1,49.8842,0.038],[1,1,54.7244,0.0356],[2,1,58.4249,0.034],[3,1,61.4292,0.0331],[4,1,63.886,0.0324],[5,1,65.9026,0.0319],[6,1,67.6236,0.0315],[9,1,71.9688,0.0308],[12,1,75.7482,0.0305],[18,1,82.3275,0.0307],[24,1,87.8285,0.0311]],
            lhfa_girls_0_2: [[0,1,49.1477,0.0379],[1,1,53.6872,0.0352],[2,1,57.0673,0.0336],[3,1,59.8029,0.0327],[4,1,62.0899,0.0322],[5,1,64.0301,0.0318],[6,1,65.7311,0.0315],[9,1,70.1396,0.0311],[12,1,74.0152,0.031],[18,1,80.7013,0.0313],[24,1,86.4172,0.0319]],
            
            // Height (2y-19y)
            lhfa_boys_2_19: [[24,1,87.1235,0.0396],[36,1,96.08,0.0409],[48,1,103.3,0.0425],[60,1,110,0.0441],[72,1,116,0.0456],[84,1,121.7,0.0469],[96,1,127,0.0481],[108,1,132.2,0.0491],[120,1,137.5,0.0499],[132,1,143,0.0503],[144,1,149,0.0504],[156,1,156,0.0499],[168,1,163.5,0.0487],[180,1,169.5,0.0469],[192,1,173.5,0.0451],[204,1,175.5,0.044],[216,1,176.5,0.0435],[228,1,176.9,0.0433]],
            lhfa_girls_2_19: [[24,1,85.7198,0.0404],[36,1,95.1,0.0416],[48,1,102.7,0.0431],[60,1,109.4,0.0447],[72,1,115.5,0.0463],[84,1,121.1,0.0478],[96,1,126.5,0.0492],[108,1,131.7,0.0505],[120,1,137.2,0.0519],[132,1,143.5,0.0535],[144,1,149.5,0.0549],[156,1,154.5,0.0558],[168,1,158.1,0.056],[180,1,160.4,0.0556],[192,1,161.8,0.0551],[204,1,162.6,0.0548],[216,1,163.1,0.0547],[228,1,163.2,0.0547]],
            
            // Weight for Length/Height (Simplified to key points for interpolation)
            // Structure: [Length/Height, L, M, S]
            wfl_boys: [[45,0.226,2.449,0.111],[50,-0.117,3.376,0.098],[60,-0.125,5.65,0.088],[70,-0.124,8.232,0.083],[80,-0.121,10.66,0.081],[90,-0.119,12.89,0.079],[100,-0.117,14.94,0.078],[110,-0.115,16.92,0.078]],
            wfl_girls: [[45,0.306,2.392,0.113],[50,-0.021,3.226,0.103],[60,-0.123,5.298,0.091],[70,-0.122,7.747,0.085],[80,-0.12,10.08,0.082],[90,-0.118,12.27,0.08],[100,-0.116,14.34,0.079],[110,-0.114,16.33,0.079]],
            wfh_boys: [[65,-0.352,7.319,0.088],[75,-0.352,9.397,0.085],[85,-0.352,11.53,0.084],[95,-0.352,13.78,0.087],[105,-0.352,16.29,0.093],[115,-0.352,19.22,0.103],[120,-0.352,20.89,0.109]],
            wfh_girls: [[65,-0.383,7.1,0.09],[75,-0.383,9.052,0.086],[85,-0.383,11.08,0.085],[95,-0.383,13.31,0.089],[105,-0.383,15.89,0.098],[115,-0.383,19.06,0.111],[120,-0.383,20.93,0.118]],
            
            // BMI for age (2y - 19y)
            bmi_boys: [[24,-0.89,15.96,0.08],[36,-1.35,15.65,0.078],[48,-1.7,15.34,0.079],[60,-1.93,15.26,0.083],[72,-2.1,15.31,0.088],[84,-2.25,15.49,0.094],[96,-2.36,15.8,0.1],[108,-2.43,16.22,0.106],[120,-2.44,16.72,0.112],[144,-2.27,17.97,0.122],[168,-1.76,19.34,0.129],[192,-1.23,20.67,0.134],[228,-0.74,21.93,0.139]],
            bmi_girls: [[24,-1.02,15.73,0.08],[36,-1.54,15.42,0.079],[48,-1.84,15.24,0.081],[60,-1.97,15.27,0.087],[72,-2.03,15.48,0.094],[84,-2.04,15.86,0.101],[96,-1.99,16.39,0.109],[108,-1.9,17.06,0.116],[120,-1.77,17.84,0.122],[144,-1.45,19.6,0.13],[168,-1.14,21.06,0.134],[192,-0.92,21.84,0.135],[228,-0.69,22.12,0.138]]
        };

        // GROUPED VACCINES WITH NOTES
        const VACCINE_GROUPS = {
            "BCG (Tuberculosis)": {
                note: "Given at birth. PPD recommended prior if >2 mos old with risk factors (congenital TB, contact, clinical findings). Contraindicated in immunologically unstable HIV.",
                doses: [
                    { name: "BCG", dose: "1", age: 0, ageText: "Birth" }
                ]
            },
            "Hepatitis B": {
                note: "Monovalent dose within 24h. 3-dose series (0, 1, 6 mos). If birth weight <2kg: Birth dose doesn't count, give 3 additional doses. HBsAg+ Mother: Give Vaccine + HBIG <12h.",
                doses: [
                    { name: "Hepatitis B (Monovalent)", dose: "1", age: 0, ageText: "Birth" }
                ]
            },
            "Rotavirus": {
                note: "Min age 6 wks. Max age for 1st dose: 15 weeks. Max age for last dose: 24 weeks (RV1) or 32 weeks (RV5). Contraindicated in SCID and history of Intussusception.",
                doses: [
                    { name: "Rotavirus", dose: "1", age: 1.5, ageText: "6 weeks" },
                    { name: "Rotavirus", dose: "2", age: 2.5, ageText: "10 weeks" }
                ]
            },
            "Pentavalent (DTP-Hib-HepB)": {
                note: "Routine: 6, 10, 14 weeks. Booster at 12-18 months. Catch-up valid until 2 years of age.",
                doses: [
                    { name: "Pentavalent", dose: "1", age: 1.5, ageText: "6 weeks" },
                    { name: "Pentavalent", dose: "2", age: 2.5, ageText: "10 weeks" },
                    { name: "Pentavalent", dose: "3", age: 3.5, ageText: "14 weeks" },
                    { name: "DTaP/DTwP", dose: "Booster 1", age: 12, ageText: "12-18 months" }
                ]
            },
            "Polio (OPV & IPV)": {
                note: "Routine: OPV at 6, 10, 14 wks + IPV at 14 wks and 9 mos. Immunocompromised: Use IPV only. OPV contraindicated in HIV.",
                doses: [
                    { name: "OPV", dose: "1", age: 1.5, ageText: "6 weeks" },
                    { name: "OPV", dose: "2", age: 2.5, ageText: "10 weeks" },
                    { name: "OPV", dose: "3", age: 3.5, ageText: "14 weeks" },
                    { name: "IPV", dose: "1", age: 3.5, ageText: "14 weeks" },
                    { name: "IPV", dose: "2", age: 9, ageText: "9 months" }
                ]
            },
            "Pneumococcal (PCV)": {
                note: "Routine: 3 primary doses (6, 10, 14 wks). High risk children (e.g., asplenia, chronic heart/lung) need additional coverage with PPSV23.",
                doses: [
                    { name: "PCV", dose: "1", age: 1.5, ageText: "6 weeks" },
                    { name: "PCV", dose: "2", age: 2.5, ageText: "10 weeks" },
                    { name: "PCV", dose: "3", age: 3.5, ageText: "14 weeks" }
                ]
            },
            "Influenza": {
                note: "Annual starting at 6 months. Children aged 6mo to 8y receiving for the FIRST time require 2 doses, 4 weeks apart.",
                doses: [
                    { name: "Influenza", dose: "Annual", age: 6, ageText: "6 months (Annual)" }
                ]
            },
            "Measles, Mumps, Rubella (MMR)": {
                note: "Routine: 9mos (Measles/MMR) & 12mos (MMR). Outbreak: Can give as early as 6mos. Delay if received IVIG/blood products.",
                doses: [
                    { name: "Measles/MMR", dose: "1", age: 9, ageText: "9 months" },
                    { name: "MMR", dose: "2", age: 12, ageText: "12 months" },
                    { name: "MMR/MR", dose: "School Entry", age: 48, ageText: "4-6 years (Grade 1)" }
                ]
            },
            "Japanese Encephalitis": {
                note: "Routine: Single dose at 9 months. Adults >17y: 1 dose if no history.",
                doses: [
                    { name: "JEV", dose: "1", age: 9, ageText: "9 months" }
                ]
            },
            "Varicella (Chickenpox)": {
                note: "Routine: 1st dose 12 mos, 2nd dose 4-6 yrs. Min interval: 3 mos (<13y) or 4 wks (>=13y). Exposure: Vaccine w/in 3-5 days.",
                doses: [
                    { name: "Varicella", dose: "1", age: 12, ageText: "12 months" },
                    { name: "Varicella", dose: "2", age: 48, ageText: "4-6 years" }
                ]
            },
            "Hepatitis A": {
                note: "Routine: 1st dose 12 mos. 2nd dose min 6 months later. Live-attenuated: Single dose (18mo+). Inactivated: 2 doses.",
                doses: [
                    { name: "Hepatitis A", dose: "1", age: 12, ageText: "12 months" },
                    { name: "Hepatitis A", dose: "2", age: 18, ageText: "18 months" }
                ]
            },
            "Tetanus/Diphtheria Boosters": {
                note: "NIP School-based: Td at Grade 1 & 7. Routine booster every 10 years. Pregnancy: 1 dose Tdap per pregnancy.",
                doses: [
                    { name: "DTaP/IPV", dose: "Booster 2", age: 48, ageText: "4-6 years" },
                    { name: "Td/Tdap", dose: "Booster", age: 84, ageText: "7-10 years (Grade 1)" },
                    { name: "Td/Tdap", dose: "Booster", age: 132, ageText: "11-12 years (Grade 7)" }
                ]
            },
            "HPV": {
                note: "Routine: 9y. Ages 9-14: 2 doses (0, 6 mos). Ages >=15 or Immunocompromised: 3 doses (0, 1, 6 mos).",
                doses: [
                    { name: "HPV", dose: "1", age: 108, ageText: "9 years" },
                    { name: "HPV", dose: "2", age: 114, ageText: "9 years + 6 mos" }
                ]
            },
            "Special / High Risk Indication": {
                note: "Not routine for all. Indicated for travelers, outbreaks, or specific risks (asplenia, animal bite).",
                doses: [
                    { name: "Typhoid", dose: "Indicated", age: 24, ageText: "2 years+ (Travel/Risk)" },
                    { name: "Meningococcal", dose: "Indicated", age: 1.5, ageText: "High Risk Groups" },
                    { name: "Rabies", dose: "PrEP", age: 24, ageText: "2-10y (High Risk Areas)" },
                    { name: "Cholera", dose: "Outbreak", age: 12, ageText: "12 mos+ (Outbreak)" }
                ]
            }
        };

        // CDC/AAP 2022 Milestones - FULL LIST
        const MILESTONES = {
            2: {
                Social: ["Calms down when spoken to or picked up", "Looks at your face", "Seems happy to see you", "Smiles when you talk to or smile at her"],
                Language: ["Makes sounds other than crying", "Reacts to loud sounds"],
                Cognitive: ["Watches you as you move", "Looks at a toy for several seconds"],
                Motor: ["Holds head up when on tummy", "Moves both arms and both legs", "Opens hands briefly"]
            },
            4: {
                Social: ["Smiles on his own to get your attention", "Chuckles (not yet a full laugh)", "Looks at you, moves, or makes sounds to get attention"],
                Language: ["Makes sounds like 'oooo', 'aahh' (cooing)", "Makes sounds back when you talk to him", "Turns head towards your voice"],
                Cognitive: ["If hungry, opens mouth when she sees breast/bottle", "Looks at hands with interest"],
                Motor: ["Holds head steady without support", "Holds a toy when you put it in hand", "Uses arm to swing at toys", "Brings hands to mouth", "Pushes up onto elbows/forearms"]
            },
            6: {
                Social: ["Knows familiar people", "Likes to look at self in mirror", "Laughs"],
                Language: ["Takes turns making sounds", "Blows 'raspberries'", "Makes squealing noises"],
                Cognitive: ["Puts things in mouth to explore", "Reaches to grab a toy", "Closes lips to show they don't want more food"],
                Motor: ["Rolls from tummy to back", "Pushes up with straight arms on tummy", "Leans on hands to support self when sitting"]
            },
            9: {
                Social: ["Is shy, clingy, or fearful around strangers", "Shows several facial expressions (happy, sad, angry)", "Looks when you call their name", "Reacts when you leave", "Smiles/laughs at peek-a-boo"],
                Language: ["Makes different sounds like 'mamamama' and 'babababa'", "Lifts arms up to be picked up"],
                Cognitive: ["Looks for objects when dropped out of sight", "Bangs two things together"],
                Motor: ["Gets to sitting position", "Moves things from one hand to other", "Uses fingers to 'rake' food", "Sits without support"]
            },
            12: {
                Social: ["Plays games like 'pat-a-cake'"],
                Language: ["Waves 'bye-bye'", "Calls a parent 'mama' or 'dada'", "Understands 'no' (pauses/stops)"],
                Cognitive: ["Puts something in a container", "Looks for things you hide"],
                Motor: ["Pulls up to stand", "Walks holding furniture", "Drinks from cup without lid (held by adult)", "Picks things up with thumb and pointer finger"]
            },
            15: {
                Social: ["Copies other children while playing", "Shows you an object they like", "Claps when excited", "Hugs stuffed doll/toy", "Shows affection"],
                Language: ["Tries to say 1-2 words besides mama/dada", "Looks at familiar object when named", "Follows directions given with gesture", "Points to ask for something"],
                Cognitive: ["Tries to use things the right way (phone, cup)", "Stacks at least 2 small objects"],
                Motor: ["Takes a few steps on own", "Uses fingers to feed self"]
            },
            18: {
                Social: ["Moves away from you but looks to make sure you are close", "Points to show you something interesting", "Puts hands out for wash", "Looks at book with you", "Helps dress"],
                Language: ["Tries to say 3 or more words besides mama/dada", "Follows 1-step directions without gestures"],
                Cognitive: ["Copies you doing chores", "Plays with toys in simple way (pushing car)"],
                Motor: ["Walks without holding on", "Scribbles", "Drinks from cup without lid (may spill)", "Climbs on/off couch", "Tries to use spoon", "Feeds self with fingers"]
            },
            24: {
                Social: ["Notices when others are hurt/upset", "Looks at your face to see reaction in new situation"],
                Language: ["Points to things in book when asked", "Says at least 2 words together", "Points to at least 2 body parts", "Uses more gestures (blowing kiss, nodding yes)"],
                Cognitive: ["Holds something in one hand while using other", "Tries to use switches/knobs", "Plays with more than 1 toy at same time"],
                Motor: ["Kicks a ball", "Runs", "Walks up few stairs", "Eats with spoon"]
            },
            30: {
                Social: ["Plays next to other children", "Shows you what they can do ('Look at me!')", "Follows simple routines"],
                Language: ["Says ~50 words", "Says 2+ words with action word", "Names things in book", "Uses I, me, we"],
                Cognitive: ["Uses things to pretend", "Shows simple problem solving", "Follows 2-step instructions", "Knows at least 1 color"],
                Motor: ["Uses hands to twist (lids, knobs)", "Takes some clothes off", "Jumps off ground with both feet", "Turns book pages 1 at a time"]
            },
            36: {
                Social: ["Calms down within 10 min after you leave", "Notices other children and joins to play"],
                Language: ["Talks with you in conversation", "Asks 'who/what/where/why'", "Says action in picture", "Says first name when asked", "Talks well enough for others to understand"],
                Cognitive: ["Draws a circle", "Avoids touching hot objects"],
                Motor: ["Strings items together", "Puts on some clothes by self", "Uses a fork"]
            },
            48: {
                Social: ["Pretends to be something else during play", "Asks to go play with children", "Comforts others who are hurt", "Avoids danger", "Likes to be helper", "Changes behavior by place"],
                Language: ["Says sentences with 4 or more words", "Says some words from song/story", "Talks about day", "Answers simple questions"],
                Cognitive: ["Names a few colors", "Tells what comes next in story", "Draws person with 3+ body parts"],
                Motor: ["Catches large ball", "Serves self food/water", "Unbuttons some buttons", "Holds crayon with fingers (not fist)"]
            },
            60: {
                Social: ["Follows rules/takes turns", "Sings/dances/acts", "Does simple chores"],
                Language: ["Tells story with 2+ events", "Answers simple questions about story", "Keeps conversation going", "Uses/recognizes simple rhymes"],
                Cognitive: ["Counts to 10", "Names some numbers", "Uses words about time", "Pays attention 5-10m", "Writes some letters in name", "Names some letters"],
                Motor: ["Buttons some buttons", "Hops on 1 foot"]
            }
        };

        // --- CORE FUNCTIONS ---

        // 1. Interpolation
        function lerp(x, x0, x1, y0, y1) {
            return y0 + (x - x0) * (y1 - y0) / (x1 - x0);
        }

        function getLMS(table, ageOrHeight) {
            // Find appropriate interval
            if (ageOrHeight <= table[0][0]) return table[0].slice(1);
            if (ageOrHeight >= table[table.length-1][0]) return table[table.length-1].slice(1);
            
            for (let i = 0; i < table.length - 1; i++) {
                if (ageOrHeight >= table[i][0] && ageOrHeight < table[i+1][0]) {
                    const t0 = table[i];
                    const t1 = table[i+1];
                    const L = lerp(ageOrHeight, t0[0], t1[0], t0[1], t1[1]);
                    const M = lerp(ageOrHeight, t0[0], t1[0], t0[2], t1[2]);
                    const S = lerp(ageOrHeight, t0[0], t1[0], t0[3], t1[3]);
                    return [L, M, S];
                }
            }
            return [0,0,0];
        }

        function calculateZScore(value, L, M, S) {
            if (L === 0) return Math.log(value / M) / S;
            return (Math.pow(value / M, L) - 1) / (L * S);
        }

        // 2. REVISED Classification Logic (Standard WHO)
        function getStatus(z, type, labelName = "") {
            if (type === 'bmi' || type === 'wfh') {
                // If labelName is provided (e.g., "Weight-for-Height" or "BMI-for-Age"), use it.
                // Otherwise fallback to generic terms if needed.
                const metric = labelName || (type === 'bmi' ? "BMI-for-Age" : "Weight-for-Height");

                if (z > 3) return { label: "Obese", color: "bg-red-100 text-red-800", note: `Urgent: ${metric} > +3 SD suggests obesity.` };
                if (z > 2) return { label: "Overweight", color: "bg-orange-100 text-orange-800", note: `Monitor: ${metric} > +2 SD suggests overweight.` };
                if (z > 1) return { label: "Risk of Overweight", color: "bg-yellow-100 text-yellow-800", note: `Risk: ${metric} > +1 SD indicates possible risk of overweight.` };
                if (z < -3) return { label: "Severely Wasted", color: "bg-red-100 text-red-800", note: `Urgent: ${metric} < -3 SD. Severe acute malnutrition requires immediate attention.` };
                if (z < -2) return { label: "Wasted", color: "bg-orange-100 text-orange-800", note: `Warning: ${metric} < -2 SD. Moderate acute malnutrition.` };
                return { label: "Normal", color: "bg-green-100 text-green-800", note: "" };
            } else if (type === 'haz') {
                const metric = labelName || "Height-for-Age";
                if (z > 3) return { label: "Tall", color: "bg-blue-100 text-blue-800", note: `Note: ${metric} > +3 SD. Consider endocrine causes if disproportionate.` };
                if (z < -3) return { label: "Severely Stunted", color: "bg-red-100 text-red-800", note: `Urgent: ${metric} < -3 SD. Severe chronic malnutrition.` };
                if (z < -2) return { label: "Stunted", color: "bg-orange-100 text-orange-800", note: `Warning: ${metric} < -2 SD. Chronic malnutrition.` };
                return { label: "Normal", color: "bg-green-100 text-green-800", note: "" };
            } else if (type === 'waz') {
                if (z > 1) return { label: "Overweight (Assess BMI)", color: "bg-yellow-100 text-yellow-800", note: "Weight-for-Age > +1 SD. Assess BMI or Weight-for-Length/Height for better classification." };
                if (z < -3) return { label: "Severely Underweight", color: "bg-red-100 text-red-800", note: "Urgent: Weight-for-Age < -3 SD." };
                if (z < -2) return { label: "Underweight", color: "bg-orange-100 text-orange-800", note: "Warning: Weight-for-Age < -2 SD." };
                return { label: "Normal", color: "bg-green-100 text-green-800", note: "" };
            }
        }

        // 3. UI Logic
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('tab-active', 'text-blue-600');
                el.classList.add('border-transparent', 'text-slate-500');
            });
            
            document.getElementById('content-' + tab).classList.remove('hidden');
            const btn = document.getElementById('tab-' + tab);
            btn.classList.add('tab-active', 'text-blue-600');
            btn.classList.remove('border-transparent', 'text-slate-500');
        }

        function calculate() {
            const dob = new Date(document.getElementById('dob').value);
            const visit = document.getElementById('visitDate').value ? new Date(document.getElementById('visitDate').value) : new Date();
            const sex = document.querySelector('input[name="sex"]:checked')?.value;
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            
            if (!dob || isNaN(dob.getTime()) || !sex) return;
            
            if (!document.getElementById('visitDate').value) {
                document.getElementById('visitDate').valueAsDate = new Date();
            }

            const diffTime = Math.abs(visit - dob);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            const ageMonths = diffDays / 30.4375;
            const ageYears = ageMonths / 12;

            const yearsDisplay = Math.floor(ageYears);
            const monthsDisplay = Math.floor(ageMonths % 12);
            const daysDisplay = Math.floor(diffDays % 30.4375);
            
            const ageContainer = document.getElementById('ageDisplay');
            ageContainer.classList.remove('hidden');
            
            ageContainer.innerHTML = `
                <div class="flex flex-col sm:flex-row sm:items-baseline gap-1">
                    <span class="font-bold text-blue-900">Age: ${yearsDisplay} years, ${monthsDisplay} months, ${daysDisplay} days</span>
                    <span class="text-xs text-blue-600/75 sm:ml-2">(${ageMonths.toFixed(1)} months)</span>
                </div>
            `;

            // --- 1. ANTHROPOMETRY ---
            if (weight && height) {
                let resultsHTML = '';
                const notes = [];
                
                const wfa_table = sex === 'male' ? WHO_DATA.wfa_boys : WHO_DATA.wfa_girls;
                
                // --- DETERMINING LENGTH VS HEIGHT LABEL ---
                let lengthTerm = "Height";
                let lengthTermFull = "Height-for-Age";
                let wfhTerm = "Weight-for-Height";
                
                let heightNote = "";
                if (ageMonths < 24) {
                    lengthTerm = "Length";
                    lengthTermFull = "Length-for-Age";
                    wfhTerm = "Weight-for-Length";
                    heightNote = "Using WHO Length-for-age (0-2y). Ensure child was measured recumbent.";
                } else {
                    // Defaults set above for > 24 months
                    heightNote = "Using WHO Height-for-age (2-19y). Ensure child was measured standing.";
                }
                notes.push({ type: 'info', text: heightNote });

                // HAZ
                let haz_table;
                if (ageMonths < 24) {
                    haz_table = sex === 'male' ? WHO_DATA.lhfa_boys_0_2 : WHO_DATA.lhfa_girls_0_2;
                } else {
                    haz_table = sex === 'male' ? WHO_DATA.lhfa_boys_2_19 : WHO_DATA.lhfa_girls_2_19;
                }
                const [l_h, m_h, s_h] = getLMS(haz_table, ageMonths);
                const haz = calculateZScore(height, l_h, m_h, s_h);
                // Pass dynamic label
                const hazStatus = getStatus(haz, "haz", lengthTermFull);
                if (hazStatus.note) notes.push({ type: haz < -2 ? 'alert' : 'info', text: hazStatus.note });
                resultsHTML += createResultCard(lengthTermFull, haz, "haz");

                // WAZ (0-10 y)
                if (ageYears <= 10) {
                    const [l_w, m_w, s_w] = getLMS(wfa_table, ageMonths);
                    const waz = calculateZScore(weight, l_w, m_w, s_w);
                    const wazStatus = getStatus(waz, "waz");
                    if (wazStatus.note) notes.push({ type: waz < -2 ? 'alert' : 'info', text: wazStatus.note });
                    resultsHTML += createResultCard("Weight-for-Age", waz, "waz");
                }

                // WHZ (0-5 y)
                if (ageYears <= 5) {
                    let whz_table;
                    if (ageMonths < 24) {
                        whz_table = sex === 'male' ? WHO_DATA.wfl_boys : WHO_DATA.wfl_girls;
                    } else {
                        whz_table = sex === 'male' ? WHO_DATA.wfh_boys : WHO_DATA.wfh_girls;
                    }
                    const [l_wh, m_wh, s_wh] = getLMS(whz_table, height);
                    const whz = calculateZScore(weight, l_wh, m_wh, s_wh);
                    // Pass dynamic label
                    const whzStatus = getStatus(whz, "wfh", wfhTerm);
                    if (whzStatus.note) notes.push({ type: whz < -2 || whz > 2 ? 'alert' : 'info', text: whzStatus.note });
                    resultsHTML += createResultCard(wfhTerm, whz, "wfh");
                }

                // BMI (2-19 y)
                if (ageYears >= 2 && ageYears <= 19) {
                    const bmi = weight / ((height/100) * (height/100));
                    const bmi_table = sex === 'male' ? WHO_DATA.bmi_boys : WHO_DATA.bmi_girls;
                    const [l_b, m_b, s_b] = getLMS(bmi_table, ageMonths);
                    const baz = calculateZScore(bmi, l_b, m_b, s_b);
                    const bmiStatus = getStatus(baz, "bmi", "BMI-for-Age");
                    if (bmiStatus.note) notes.push({ type: baz < -2 || baz > 1 ? 'alert' : 'info', text: bmiStatus.note });
                    resultsHTML += createResultCard(`BMI-for-Age (${bmi.toFixed(1)})`, baz, "bmi");
                } else if (ageYears < 2) {
                     resultsHTML += `<div class="stat-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm opacity-50"><h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">BMI-for-Age</h4><p class="text-sm">Not applicable < 2 years</p></div>`;
                }

                document.getElementById('resultsGrid').innerHTML = resultsHTML;
                
                // Render Dynamic Notes
                const notesContainer = document.getElementById('dynamicNotesContainer');
                notesContainer.innerHTML = '';
                notes.forEach(note => {
                    const colorClass = note.type === 'alert' 
                        ? 'bg-red-50 border-red-200 text-red-800' 
                        : 'bg-yellow-50 border-yellow-200 text-yellow-800';
                    
                    notesContainer.innerHTML += `
                        <div class="${colorClass} border rounded-lg p-3 text-sm flex items-start">
                            <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>${note.text}</span>
                        </div>
                    `;
                });
            }

            // --- 2. IMMUNIZATIONS ---
            renderImmunizations(ageMonths);

            // --- 3. MILESTONES ---
            renderMilestones(ageMonths);
        }

        function createResultCard(title, z, type) {
            const status = getStatus(z, type);
            const zFormatted = z > 0 ? `+${z.toFixed(2)}` : z.toFixed(2);
            // Visual bar scaling: Map -4 to +4 range to 0-100%
            const percent = Math.min(Math.max(((z + 4) / 8) * 100, 0), 100);

            return `
                <div class="stat-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">${title}</h4>
                    <div class="flex items-baseline justify-between mb-2">
                        <span class="text-3xl font-bold text-slate-900">${zFormatted} <span class="text-sm font-normal text-slate-400">SD</span></span>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${status.color}">
                        ${status.label}
                    </span>
                    
                    <div class="mt-4">
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span>-3</span>
                            <span>0</span>
                            <span>+3</span>
                        </div>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden relative">
                            <div class="absolute top-0 bottom-0 w-0.5 bg-slate-300 left-1/2"></div>
                            <!-- Markers for -2 and +2 -->
                            <div class="absolute top-0 bottom-0 w-px bg-slate-200 left-[25%]"></div>
                            <div class="absolute top-0 bottom-0 w-px bg-slate-200 left-[75%]"></div>
                            
                            <div class="absolute top-0 bottom-0 w-2 h-2 rounded-full bg-blue-600 -ml-1 border-2 border-white shadow-sm transition-all duration-500" style="left: ${percent}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderImmunizations(ageMonths) {
            const container = document.getElementById('immunizationContainer');
            // Keep header (first child), remove rest
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            for (const [groupName, groupData] of Object.entries(VACCINE_GROUPS)) {
                // Group Header
                let groupHtml = `
                    <div class="bg-slate-50 border-b border-slate-200 px-4 sm:px-6 py-3 mt-0">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
                            <h4 class="font-bold text-slate-900 uppercase tracking-wider text-sm">${groupName}</h4>
                            ${groupData.note ? `<p class="text-xs text-slate-500 italic bg-white px-2 py-1 rounded border border-slate-200 inline-block"><span class="font-semibold text-slate-600">Note:</span> ${groupData.note}</p>` : ''}
                        </div>
                    </div>
                `;
                
                let rowsHtml = "";

                // Rows
                groupData.doses.forEach(vac => {
                    let status = "";
                    let statusClass = "";
                    
                    if (vac.dose === "Indicated" || vac.dose === "PrEP" || vac.dose === "Outbreak") {
                         if (ageMonths >= vac.age) {
                             status = "If Indicated";
                             statusClass = "text-amber-600 font-medium bg-amber-50 border border-amber-100";
                         } else {
                             status = "Too Young";
                             statusClass = "text-slate-400 bg-slate-50 border border-slate-100";
                         }
                    } else if (ageMonths < vac.age) {
                        status = "Upcoming";
                        statusClass = "text-slate-500 bg-white border border-slate-100";
                    } else if (ageMonths >= vac.age && ageMonths <= (vac.age + 3)) { 
                        status = "Due Now";
                        statusClass = "text-blue-700 font-bold bg-blue-50 border border-blue-100";
                    } else {
                        status = "Overdue";
                        statusClass = "text-red-700 font-bold bg-red-50 border border-red-100";
                    }

                    rowsHtml += `
                    <div class="p-4 sm:px-6 hover:bg-slate-50 transition-colors grid grid-cols-1 md:grid-cols-12 gap-y-2 md:gap-x-4 items-start md:items-center border-b border-slate-100 last:border-0">
                        <!-- Vaccine Name -->
                        <div class="md:col-span-4 font-medium text-slate-900 text-sm">
                            ${vac.name}
                        </div>

                        <!-- Wrapper using contents for alignment -->
                        <div class="col-span-1 md:contents grid grid-cols-2 gap-y-1 w-full items-center">
                            
                            <!-- Dose -->
                            <div class="md:col-span-2 text-sm text-slate-500">
                                <span class="md:hidden text-xs font-bold uppercase text-slate-300 block mb-1">Dose</span>
                                ${vac.dose}
                            </div>

                            <!-- Age -->
                            <div class="md:col-span-3 text-sm text-slate-500">
                                <span class="md:hidden text-xs font-bold uppercase text-slate-300 block mb-1">Rec. Age</span>
                                ${vac.ageText}
                            </div>

                            <!-- Status -->
                            <div class="col-span-2 md:col-span-3 md:text-right mt-2 md:mt-0">
                                <span class="${statusClass} text-xs md:text-sm px-3 py-1 rounded-full inline-block text-center w-full md:w-auto shadow-sm">
                                    ${status}
                                </span>
                            </div>
                        </div>
                    </div>
                    `;
                });
                
                const groupDiv = document.createElement('div');
                groupDiv.innerHTML = groupHtml + rowsHtml;
                container.appendChild(groupDiv);
            }
        }

        function renderMilestones(ageMonths) {
            const container = document.getElementById('milestoneGrid');
            const ageLabel = document.getElementById('milestoneAgeGroup');
            container.innerHTML = '';
            container.className = 'space-y-12';

            const milestoneAges = Object.keys(MILESTONES).map(Number).sort((a,b) => b-a);
            let currentAgeGroup = 0;
            
            const ascendingAges = [...milestoneAges].sort((a,b) => a-b);
            for (let age of ascendingAges) {
                if (ageMonths >= age) {
                    currentAgeGroup = age;
                }
            }
            if (ageMonths > 60) currentAgeGroup = 60;

            if (ageMonths < 2) {
                container.innerHTML = `<div class="col-span-full text-center text-slate-500 p-8">Child is too young for the 2-month milestone checklist.</div>`;
                ageLabel.textContent = "< 2 months";
                return;
            }

            const applicableAges = milestoneAges.filter(age => age <= currentAgeGroup);
            ageLabel.textContent = `${applicableAges[applicableAges.length-1]} - ${currentAgeGroup} Months`;

            const domains = {
                'Social': 'bg-pink-50 text-pink-700 border-pink-200',
                'Language': 'bg-blue-50 text-blue-700 border-blue-200',
                'Cognitive': 'bg-purple-50 text-purple-700 border-purple-200',
                'Motor': 'bg-green-50 text-green-700 border-green-200'
            };

            applicableAges.forEach(age => {
                const data = MILESTONES[age];
                let sectionHtml = `
                    <div class="border-t border-slate-100 pt-8 first:border-0 first:pt-0">
                        <h4 class="text-xl font-bold text-slate-800 mb-4 px-1">${age} Month Checklist</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                `;

                for (const [domain, items] of Object.entries(data)) {
                    let itemsHtml = items.map(item => `
                        <li class="flex items-start mb-2 group cursor-pointer hover:bg-white/50 p-1 rounded transition-colors select-none">
                            <input type="checkbox" class="milestone-check h-5 w-5 mt-0.5 mr-3 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                            <span class="text-slate-700 text-sm group-hover:text-slate-900 leading-relaxed">${item}</span>
                        </li>
                    `).join('');

                    const displayDomain = domain === 'Social' ? 'Social & Emotional' : domain;

                    sectionHtml += `
                        <div class="border rounded-lg p-4 ${domains[domain].replace('bg-', 'border-opacity-50 ')}">
                            <h4 class="font-bold mb-3 ${domains[domain].split(' ')[1]}">${displayDomain}</h4>
                            <ul class="list-none">
                                ${itemsHtml}
                            </ul>
                        </div>
                    `;
                }
                sectionHtml += `</div></div>`;
                container.innerHTML += sectionHtml;
            });
        }
        
        document.getElementById('dob').max = new Date().toISOString().split("T")[0];
    </script>
</body>
</html>
